## 概述

有的时候，一个Mod中，为原版的世界添加新的世界生成是少不了的。然而作为一个Minecraft玩家，往往会在初期花费大量时间来进行挖矿的活动。因此，一个Mod的世界生成，往往最主要的就是在地下矿物的生成。Forge提供了一个名为`IWorldGenerator`的接口，通过实现这个接口，并注册它，我们就可以让Minecraft在适当时机，和我们想要的地点生成矿物。本部分将以在地下以生成矿物的形式生成萤石为例，带领读者一步一步、按部就班地完成一个世界生成器的制作，和注册。

但是这里，作者想要提醒读者一句：**如果不是探险类Mod，一个好的Mod，除了一些必要的矿物生成，真正世界生成的部分是很少的。**换句话说，一个好的Mod，如果不具备很强烈的探险性质，应该**尽量减少世界生成部分**，可以换一些方式，比如使用方块破坏掉落、生物破坏掉落、等等，以实现新的物品、方块等的产生。当然，一个主打冒险的Mod，或者一些大量添加了冒险元素的魔法性质的Mod，等等，涉及到了其他世界生成，这些内容比较复杂，会在高级部分进行讲解。

## 世界生成器的创建和注册

刚刚说到，Forge提供了一个名为`IWorldGenerator`的接口。这个接口只有一个名为`generate`的方法，当注册了这个世界生成器之后，Forge就会在**每个区块**生成的时候，调用这个方法。我们接下来研究一下这个方法：

```java
    public void generate(Random random, int chunkX, int chunkZ, World world, IChunkProvider chunkGenerator, IChunkProvider chunkProvider);
```

这个方法一共提供了六个参数，我们先跳过第一个参数，看一看剩下的五个参数：

* 第二个参数和第三个参数分别表示Forge用于生成的时候，当前的**区块**的横纵坐标，如果要求出对应的世界坐标，需要分别乘以16，比如当这两个参数，分别为3和-5的时候，对应的区块的x坐标就在48与63之间，z坐标就在-80与-65之间
* 第四个参数表示的就是用于生成的世界了
* 第五个参数和第六个参数和生成的世界类型有关，这两个参数往往不会用到，开发者往往也不用考虑

现在我们再来说说第一个参数。第一个参数是一个和**当前世界种子**、**当前区块的x坐标（第二个参数）**、和**当前区块的z坐标（第三个参数）**相关，且只和这些相关的随机数发生器，换言之，如果当前即将生成的是同一个世界种子和同一个区块，这个随机数发生器总会是一致的。所以，为了保证相同的种子生成相同的世界，请**在世界生成的时候应当只使用这个随机数发生器**。

我们新建包`com.github.ustc_zzzz.fmltutor.worldgen`，并在其中新建文件`WorldGeneratorGlowstone.java`：

**`src/main/java/com/github/ustc_zzzz/fmltutor/worldgen/WorldGeneratorGlowstone.java:`**

```java
package com.github.ustc_zzzz.fmltutor.worldgen;

import java.util.Random;

import net.minecraft.world.World;
import net.minecraft.world.chunk.IChunkProvider;
import net.minecraftforge.fml.common.IWorldGenerator;

public class WorldGeneratorGlowstone implements IWorldGenerator
{
    @Override
    public void generate(Random random, int chunkX, int chunkZ, World world, IChunkProvider chunkGenerator,
            IChunkProvider chunkProvider)
    {
        // TODO
    }
}
```

Forge在`GameRegistry`类提供了一个静态方法`registerWorldGenerator`，用于注册世界生成器。

在包`com.github.ustc_zzzz.fmltutor.worldgen`下新建文件`WorldGeneratorLoader.java`：

**`src/main/java/com/github/ustc_zzzz/fmltutor/worldgen/WorldGeneratorLoader.java:`**

```java
package com.github.ustc_zzzz.fmltutor.worldgen;

import net.minecraftforge.fml.common.IWorldGenerator;
import net.minecraftforge.fml.common.registry.GameRegistry;

public class WorldGeneratorLoader
{
    public static IWorldGenerator generatorGlowstone = new WorldGeneratorGlowstone();

    public WorldGeneratorLoader()
    {
        GameRegistry.registerWorldGenerator(generatorGlowstone, 1);
    }
}
```

## 生成矿物

其实，Minecraft的生成矿物的方式一点都不容易，比如说生成矿物的时候要保证矿物块的大小相近，被替换成矿物的方块不能是基岩这种方块，也不能是空气。不过幸运的是，Minecraft已经给我们完成了一部分，那就是`WorldGenMinable`类。这个类可以满足生成一般矿物的要求了。

这里先贴上教程作为演示的代码：

**`src/main/java/com/github/ustc_zzzz/fmltutor/worldgen/WorldGeneratorGlowstone.java（部分）:`**

```java
    public final WorldGenMinable glowstoneGenerator = new WorldGenMinable(Blocks.glowstone.getDefaultState(), 16);

    @Override
    public void generate(Random random, int chunkX, int chunkZ, World world, IChunkProvider chunkGenerator,
            IChunkProvider chunkProvider)
    {
        if (world.provider.getDimensionId() != 0)
        {
            return;
        }
        for (int i = 0; i < 4; ++i)
        {
            int posX = chunkX * 16 + random.nextInt(16);
            int posY = 16 + random.nextInt(16);
            int posZ = chunkZ * 16 + random.nextInt(16);
            BlockPos blockpos = new BlockPos(posX, posY, posZ);
            BiomeGenBase biomeGenBase = world.getBiomeGenForCoords(blockpos);
            if (biomeGenBase.getIntRainfall() < random.nextInt(65536))
            {
                glowstoneGenerator.generate(world, random, blockpos);
            }
        }
    }
```

`WorldGenMinable`类的一个常用构造方法一共需要两个参数：

    public WorldGenMinable(IBlockState p_i45630_1_, int p_i45630_2_) {...}

* 第一个参数表示生成的矿物的方块状态，方块状态的相关内容在中级部分会有所讲解，这里只需要知道通过方块的`getDefaultState`方法获取这个方块状态就可以了。比如这里我们需要生成萤石，我们就可以通过`Blocks.glowstone.getDefaultState()`的方式获取到这个方块状态
* 第二个参数表示生成的矿物的大小，当然实际大小是会有出入的，这里我们定为16

我们先实例化一个`WorldGenMinable`：

```java
    public final WorldGenMinable glowstoneGenerator = new WorldGenMinable(Blocks.glowstone.getDefaultState(), 16);
```

然后我们来看这一段：

```java
        if (world.provider.getDimensionId() != 0)
        {
            return;
        }
```

我们要获取这个世界的维度，这里教程做为生成萤石的演示，只希望在主世界生成（下界自带对吧2333），那么我们就要通过这个世界（第四个参数）的`provider`的`getDimensionId`方法获取这个世界的维度，0是主世界，-1是下界，1是末界。当然，除此之外，一些Mod会提供新的世界维度，这里就要自己去查找相关资料了。

当世界的维度符合要求了之后：

```java
        for (int i = 0; i < 4; ++i)
        {
            int posX = chunkX * 16 + random.nextInt(16);
            int posY = 16 + random.nextInt(16);
            int posZ = chunkZ * 16 + random.nextInt(16);
            BlockPos blockpos = new BlockPos(posX, posY, posZ);
            BiomeGenBase biomeGenBase = world.getBiomeGenForCoords(blockpos);
            if (biomeGenBase.getIntRainfall() < random.nextInt(65536))
            {
                glowstoneGenerator.generate(world, random, blockpos);
            }
        }
```

一般情况下一个区块不会只生成一次矿物，比如这里我们通过循环四次的方式在当前区块进行四次矿物生成。

```java
            int posX = chunkX * 16 + random.nextInt(16);
            int posY = 16 + random.nextInt(16);
            int posZ = chunkZ * 16 + random.nextInt(16);
            BlockPos blockpos = new BlockPos(posX, posY, posZ);
```

然后我们随机在当前区块内生成xyz三个坐标值，当然这里我们需要使用Forge提供的随机数生成器，不难看出，这里我们设定萤石的生成范围是y坐标（也就是纵坐标）从16到32。

```java
            BiomeGenBase biomeGenBase = world.getBiomeGenForCoords(blockpos);
```

有的时候，在世界上生成的矿物，还需要依赖于生物群系，比如绿宝石的生成就和生物群系密切相关，这里我们使用`World`类的`getBiomeGenForCoords`方法获取这个方块所在位置所在的生物群系。

```java
            if (biomeGenBase.getIntRainfall() < random.nextInt(65536))
            {
                glowstoneGenerator.generate(world, random, blockpos);
            }
```

这里教程作为演示，对于生物群系的特殊设定是获取生物群系的降雨量（在0到65536之间），如果生物群系的降雨量如果较大（比如雨林），则该次生成成功的概率偏小，如果偏小（比如沙漠），则该次生成成功的概率偏大。

最后我们通过调用我们实例化的`WorldGenMinable`的`generate`方法生成这个矿物：

```java
                glowstoneGenerator.generate(world, random, blockpos);
```

这一名为`generate`的方法需要传入三个参数，第一个参数表示生成位置所在的世界，第二个参数传入一个随机数生成器，第三个参数表示生成的位置。

到这里，一个用于生成矿物的世界生成器就制作完成了。

最后少不了的在`CommonProxy`中注册：

**`src/main/java/com/github/ustc_zzzz/fmltutor/common/CommonProxy.java（部分）:`**

        public void init(FMLInitializationEvent event)
        {
            new CraftingLoader();
            new EnchantmentLoader();
            new AchievementLoader();
            new EventLoader();
            new WorldGeneratorLoader();
        }

打开游戏，新建一个世界，或者跑到之前还未有生成过的世界部分，去深入地下看看吧～

已有生成的世界部分，自然已经不会再生成矿物了。
